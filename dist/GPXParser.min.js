let gpxParser=function(){this.xmlSource="",this.metadata={},this.waypoints=[],this.tracks=[],this.routes=[]};gpxParser.prototype.parse=function(e){var t,l,r,a=this,n=new window.DOMParser,n=(this.xmlSource=n.parseFromString(e,"text/xml"),this.xmlSource.querySelector("metadata")),i=(null!=n&&(this.metadata.name=this.getElementValue(n,"name"),this.metadata.desc=this.getElementValue(n,"desc"),this.metadata.time=this.getElementValue(n,"time"),e={},null!=(t=n.querySelector("author"))&&(e.name=this.getElementValue(t,"name"),e.email={},null!=(l=t.querySelector("email"))&&(e.email.id=l.getAttribute("id"),e.email.domain=l.getAttribute("domain")),l={},null!=(t=t.querySelector("link"))&&(l.href=t.getAttribute("href"),l.text=this.getElementValue(t,"text"),l.type=this.getElementValue(t,"type")),e.link=l),this.metadata.author=e,t={},null!=(l=this.queryDirectSelector(n,"link")))&&(t.href=l.getAttribute("href"),t.text=this.getElementValue(l,"text"),t.type=this.getElementValue(l,"type"),this.metadata.link=t),[].slice.call(this.xmlSource.querySelectorAll("wpt")));for(r in i){var s=i[r],o={},u=(o.name=a.getElementValue(s,"name"),o.sym=a.getElementValue(s,"sym"),o.lat=parseFloat(s.getAttribute("lat")),o.lon=parseFloat(s.getAttribute("lon")),parseFloat(a.getElementValue(s,"ele"))),u=(o.ele=isNaN(u)?null:u,o.cmt=a.getElementValue(s,"cmt"),o.desc=a.getElementValue(s,"desc"),a.getElementValue(s,"time"));o.time=null==u?null:new Date(u),a.waypoints.push(o)}var p,c=[].slice.call(this.xmlSource.querySelectorAll("rte"));for(p in c){var m,h=c[p],g={},y=(g.name=a.getElementValue(h,"name"),g.cmt=a.getElementValue(h,"cmt"),g.desc=a.getElementValue(h,"desc"),g.src=a.getElementValue(h,"src"),g.number=a.getElementValue(h,"number"),a.queryDirectSelector(h,"type")),y=(g.type=null!=y?y.innerHTML:null,{}),d=h.querySelector("link"),f=(null!=d&&(y.href=d.getAttribute("href"),y.text=a.getElementValue(d,"text"),y.type=a.getElementValue(d,"type")),g.link=y,[]),x=[].slice.call(h.querySelectorAll("rtept"));for(m in x){var E=x[m],v={},V=(v.lat=parseFloat(E.getAttribute("lat")),v.lon=parseFloat(E.getAttribute("lon")),parseFloat(a.getElementValue(E,"ele"))),V=(v.ele=isNaN(V)?null:V,a.getElementValue(E,"time"));v.time=null==V?null:new Date(V),f.push(v)}g.distance=a.calculDistance(f),g.elevation=a.calcElevation(f),g.slopes=a.calculSlope(f,g.distance.cumul),g.points=f,a.routes.push(g)}var S,H=[].slice.call(this.xmlSource.querySelectorAll("trk"));for(S in H){var O,b=H[S],k={},q=(k.name=a.getElementValue(b,"name"),k.cmt=a.getElementValue(b,"cmt"),k.desc=a.getElementValue(b,"desc"),k.src=a.getElementValue(b,"src"),k.number=a.getElementValue(b,"number"),a.queryDirectSelector(b,"type")),q=(k.type=null!=q?q.innerHTML:null,{}),A=b.querySelector("link"),j=(null!=A&&(q.href=A.getAttribute("href"),q.text=a.getElementValue(A,"text"),q.type=a.getElementValue(A,"type")),k.link=q,[]),C=[].slice.call(b.querySelectorAll("trkseg"));for(O in C){var G,I=C[O],F={},M=[],J=[].slice.call(I.querySelectorAll("trkpt"));for(G in J){var w=J[G],D={},P=(D.lat=parseFloat(w.getAttribute("lat")),D.lon=parseFloat(w.getAttribute("lon")),parseFloat(a.getElementValue(w,"ele"))),P=(D.ele=isNaN(P)?null:P,a.getElementValue(w,"time"));D.time=null==P?null:new Date(P),M.push(D)}F.distance=a.calculDistance(M),F.time=a.calculTime(M),F.elevation=a.calcElevation(M),F.slopes=a.calculSlope(M,F.distance.cumul),F.points=M,j.push(F)}var z,N=[],K=[].slice.call(b.querySelectorAll("trkpt"));for(z in K){var T=K[z],L={},B=(L.lat=parseFloat(T.getAttribute("lat")),L.lon=parseFloat(T.getAttribute("lon")),parseFloat(a.getElementValue(T,"ele"))),B=(L.ele=isNaN(B)?null:B,a.getElementValue(T,"time"));L.time=null==B?null:new Date(B),N.push(L)}k.distance=a.calculDistance(N),k.time=a.calculTime(N),k.elevation=a.calcElevation(N),k.slopes=a.calculSlope(N,k.distance.cumul),k.segments=j,a.tracks.push(k)}},gpxParser.prototype.getElementValue=function(e,t){e=e.querySelector(t);return null!=e?null!=e.innerHTML?e.innerHTML:e.childNodes[0].data:e},gpxParser.prototype.queryDirectSelector=function(e,t){var l=e.querySelectorAll(t);let r=l[0];if(1<l.length){var a=e.childNodes;for(idx in a)(elem=a[idx]).tagName===t&&(r=elem)}return r},gpxParser.prototype.calculDistance=function(e){var t={};let l=0;for(var r=[],a=0;a<e.length-1;a++)l+=this.calcDistanceBetween(e[a],e[a+1]),r[a]=l;return r[r.length-1]=l,t.total=l,t.cumul=r,t},gpxParser.prototype.calculTime=function(e){var t={};let l=0;for(var r=[],a=0;a<e.length-1;a++)l+=this.calcTimeBetween(e[a],e[a+1]),r[a]=l;return r[r.length-1]=l,t.total=l,t.cumul=r,t},gpxParser.prototype.calcDistanceBetween=function(e,t){var l={},e=(l.lat=e.lat,l.lon=e.lon,{}),t=(e.lat=t.lat,e.lon=t.lon,Math.PI/180),r=l.lat*t,a=e.lat*t,n=Math.sin((e.lat-l.lat)*t/2),e=Math.sin((e.lon-l.lon)*t/2),l=n*n+Math.cos(r)*Math.cos(a)*e*e;return 6371e3*(2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)))},gpxParser.prototype.calcTimeBetween=function(e,t){e=e.time;return t.time-e},gpxParser.prototype.calcElevation=function(e){for(var t=0,l=0,r={},a=0;a<e.length-1;a++){var n=e[a+1].ele,i=e[a].ele;null!==n&&null!==i&&((n=parseFloat(n)-parseFloat(i))<0?l+=n:0<n&&(t+=n))}for(var s,o=[],u=0,a=0,p=e.length;a<p;a++)null!==e[a].ele&&(s=parseFloat(e[a].ele),o.push(s),u+=s);return r.max=Math.max.apply(null,o)||null,r.min=Math.min.apply(null,o)||null,r.pos=Math.abs(t)||null,r.neg=Math.abs(l)||null,r.avg=u/o.length||null,r},gpxParser.prototype.calculSlope=function(e,t){for(var l=[],r=0;r<e.length-1;r++){var a=e[r],a=e[r+1].ele-a.ele,n=t[r+1]-t[r];l.push(100*a/n)}return l},gpxParser.prototype.toGeoJSON=function(){var e={type:"FeatureCollection",features:[],properties:{name:this.metadata.name,desc:this.metadata.desc,time:this.metadata.time,author:this.metadata.author,link:this.metadata.link}};for(idx in this.tracks){var t=this.tracks[idx];for(idx in(i={type:"Feature",geometry:{type:"LineString",coordinates:[]},properties:{}}).properties.name=t.name,i.properties.cmt=t.cmt,i.properties.desc=t.desc,i.properties.src=t.src,i.properties.number=t.number,i.properties.link=t.link,i.properties.type=t.type,t.points){var l=t.points[idx];(a=[]).push(l.lon),a.push(l.lat),a.push(l.ele),i.geometry.coordinates.push(a)}e.features.push(i)}for(idx in this.routes){var r=this.routes[idx];for(idx in(i={type:"Feature",geometry:{type:"LineString",coordinates:[]},properties:{}}).properties.name=r.name,i.properties.cmt=r.cmt,i.properties.desc=r.desc,i.properties.src=r.src,i.properties.number=r.number,i.properties.link=r.link,i.properties.type=r.type,r.points){var a,n=r.points[idx];(a=[]).push(n.lon),a.push(n.lat),a.push(n.ele),i.geometry.coordinates.push(a)}e.features.push(i)}for(idx in this.waypoints){var i,s=this.waypoints[idx];(i={type:"Feature",geometry:{type:"Point",coordinates:[]},properties:{}}).properties.name=s.name,i.properties.sym=s.sym,i.properties.cmt=s.cmt,i.properties.desc=s.desc,i.geometry.coordinates=[s.lon,s.lat,s.ele],e.features.push(i)}return e},"undefined"!=typeof module&&(require("jsdom-global")(),module.exports=gpxParser);